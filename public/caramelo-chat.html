<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Caramelo Vet - Chat</title>
  <style>
    :root {
      --bg-color: #f3f3f3;
      --bg-chat: #ffffff;
      --header-bg: #ffcc66;
      --header-border: #e6b85c;
      --header-text: #4a320a;
      --user-bubble: #d6eaff;
      --caramelo-bubble: #fff2d6;
      --text-color: #222;
      --input-bg: #ffffff;
      --input-border: #aaa;
      --button-bg: #ffcc66;
      --button-bg-hover: #e6b85c;
      --button-text: #4a320a;
      --chip-bg: #ffe7b3;
      --chip-border: #f2c46a;
    }

    body.dark {
      --bg-color: #121212;
      --bg-chat: #1e1e1e;
      --header-bg: #3b2a10;
      --header-border: #5a4020;
      --header-text: #ffdd8a;
      --user-bubble: #26415a;
      --caramelo-bubble: #3c2b17;
      --text-color: #f1f1f1;
      --input-bg: #2a2a2a;
      --input-border: #555;
      --button-bg: #ffcc66;
      --button-bg-hover: #e6b85c;
      --button-text: #4a320a;
      --chip-bg: #4a351b;
      --chip-border: #f2c46a;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      background: var(--header-bg);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 2px solid var(--header-border);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-avatar {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: #d19445;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      box-shadow: 0 0 0 0 rgba(0,0,0,0.2);
      animation: avatarPulse 2s infinite;
    }

    @keyframes avatarPulse {
      0% { box-shadow: 0 0 0 0 rgba(0,0,0,0.25); }
      70% { box-shadow: 0 0 0 10px rgba(0,0,0,0); }
      100% { box-shadow: 0 0 0 0 rgba(0,0,0,0); }
    }

    .header-title {
      display: flex;
      flex-direction: column;
    }

    .header-title span:nth-child(1) {
      font-size: 18px;
      font-weight: bold;
      color: var(--header-text);
    }

    .header-title span:nth-child(2) {
      font-size: 12px;
      color: rgba(0,0,0,0.6);
    }

    body.dark .header-title span:nth-child(2) {
      color: rgba(255,255,255,0.6);
    }

    .header-right {
      display: flex;
      gap: 8px;
    }

    .header-btn {
      border: none;
      padding: 6px 10px;
      border-radius: 999px;
      cursor: pointer;
      background: rgba(255,255,255,0.3);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .header-btn span {
      font-size: 16px;
    }

    #chatWrapper {
      flex: 1;
      display: flex;
      justify-content: center;
      padding: 10px;
    }

    #chatContainer {
      width: 100%;
      max-width: 900px;
      background: var(--bg-chat);
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    #quickActions {
      padding: 10px 14px 4px 14px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    #quickActionsTitle {
      font-size: 12px;
      color: rgba(0,0,0,0.6);
    }

    body.dark #quickActionsTitle {
      color: rgba(255,255,255,0.6);
    }

    #quickActionsRow {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 4px;
    }

    #quickActionsRow::-webkit-scrollbar {
      height: 6px;
    }
    #quickActionsRow::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,0.2);
      border-radius: 3px;
    }
    body.dark #quickActionsRow::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
    }

    .chip {
      min-width: 160px;
      max-width: 220px;
      background: var(--chip-bg);
      border: 1px solid var(--chip-border);
      border-radius: 12px;
      padding: 8px 10px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex-shrink: 0;
    }

    .chip-title {
      font-size: 13px;
      font-weight: bold;
      color: #4a320a;
    }

    body.dark .chip-title {
      color: #ffdd8a;
    }

    .chip-desc {
      font-size: 11px;
      color: rgba(0,0,0,0.7);
    }

    body.dark .chip-desc {
      color: rgba(255,255,255,0.7);
    }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 14px;
    }

    .msg-row {
      display: flex;
      margin-bottom: 14px;
    }

    .msg-row.user {
      justify-content: flex-end;
    }

    .msg-row.caramelo {
      justify-content: flex-start;
    }

    .msg {
      max-width: 75%;
      padding: 10px 14px;
      border-radius: 14px;
      line-height: 1.4em;
      white-space: pre-wrap;
      font-size: 14px;
    }

    .msg.user {
      background: var(--user-bubble);
      border-bottom-right-radius: 4px;
    }

    .msg.caramelo {
      background: var(--caramelo-bubble);
      border-bottom-left-radius: 4px;
      display: flex;
      gap: 8px;
    }

    .msg-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #d19445;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .msg-text {
      flex: 1;
    }

    #inputArea {
      padding: 10px 14px;
      background: var(--input-bg);
      border-top: 1px solid var(--input-border);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #msgInput {
      flex: 1;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--input-border);
      font-size: 15px;
      background: var(--input-bg);
      color: var(--text-color);
      outline: none;
    }

    #msgInput::placeholder {
      color: #888;
    }

    .circle-btn {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      background: var(--button-bg);
      color: var(--button-text);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: 0.2s;
    }

    .circle-btn:hover {
      background: var(--button-bg-hover);
    }

    #sendBtn {
      width: 44px;
      height: 44px;
      font-size: 20px;
    }

    #typingRow {
      display: none;
      margin-bottom: 12px;
    }

    .typing-bubble {
      background: var(--caramelo-bubble);
      padding: 8px 12px;
      border-radius: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .typing-dots {
      display: flex;
      gap: 4px;
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #b58a4a;
      animation: typing 1s infinite ease-in-out;
    }

    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {
      0% { transform: translateY(0); opacity: 0.5; }
      50% { transform: translateY(-3px); opacity: 1; }
      100% { transform: translateY(0); opacity: 0.5; }
    }

    #messages::-webkit-scrollbar {
      width: 8px;
    }
    #messages::-webkit-scrollbar-track {
      background: transparent;
    }
    #messages::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,0.2);
      border-radius: 4px;
    }

    body.dark #messages::-webkit-scrollbar-thumb {
      background: rgba(255,255,255,0.2);
    }

    @media (max-width: 600px) {
      header {
        padding: 8px 10px;
      }
      #chatWrapper {
        padding: 6px;
      }
      #messages {
        padding: 10px;
      }
      .msg {
        max-width: 85%;
      }
      .chip {
        min-width: 140px;
        max-width: 200px;
      }
    }
  </style>
</head>
<body class="light">
  <header>
    <div class="header-left">
      <div class="header-avatar">üê∂</div>
      <div class="header-title">
        <span>Caramelo Vet</span>
        <span>Seu melhor amigo virtual na rotina veterin√°ria</span>
      </div>
    </div>
    <div class="header-right">
      <button id="themeToggle" class="header-btn" title="Alternar tema claro/escuro">
        <span id="themeIcon">üåô</span> <span>Modo</span>
      </button>
      <button id="clearChat" class="header-btn" title="Limpar conversa">
        <span>üßπ</span> <span>Limpar</span>
      </button>
    </div>
  </header>

  <div id="chatWrapper">
    <div id="chatContainer">
      <div id="quickActions">
        <div id="quickActionsTitle">Sugest√µes r√°pidas (quebra-gelos):</div>
        <div id="quickActionsRow">
          <div class="chip" id="chipClinica">
            <div class="chip-title">Cl√≠nica m√©dica üê∂üê±</div>
            <div class="chip-desc">Casos cl√≠nicos, sinais e condutas.</div>
          </div>
          <div class="chip" id="chipExames">
            <div class="chip-title">Interpretar exames ü©∫üìä</div>
            <div class="chip-desc">Hemograma, bioqu√≠mica, imagem e mais.</div>
          </div>
          <div class="chip" id="chipAula">
            <div class="chip-title">Gravar aula üé•üìö</div>
            <div class="chip-desc">Organizar roteiro de aula ou caso cl√≠nico.</div>
          </div>
          <div class="chip" id="chipSutura">
            <div class="chip-title">Fio e sutura ü™°</div>
            <div class="chip-desc">Escolha de fio e padr√£o de sutura.</div>
          </div>
          <div class="chip" id="chipAlexia">
            <div class="chip-title">Alexia ‚ö°</div>
            <div class="chip-desc">D√∫vida r√°pida e objetiva.</div>
          </div>
        </div>
      </div>

      <div id="messages">
        <div id="typingRow" class="msg-row caramelo">
          <div class="typing-bubble">
            <div class="msg-avatar">üê∂</div>
            <div class="typing-dots">
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="inputArea">
        <input
          type="text"
          id="msgInput"
          placeholder="Digite seu caso cl√≠nico, d√∫vida ou exame aqui..."
        />
        <button id="micBtn" class="circle-btn" title="Ditado por voz (Chrome)">
          üéôÔ∏è
        </button>
        <button id="sendBtn" class="circle-btn" title="Enviar">
          ‚û§
        </button>
      </div>
    </div>
  </div>

  <script>
    const EMAIL = "teste@teste.com";

    const messagesEl = document.getElementById("messages");
    const typingRow = document.getElementById("typingRow");
    const input = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");
    const micBtn = document.getElementById("micBtn");
    const themeToggle = document.getElementById("themeToggle");
    const themeIcon = document.getElementById("themeIcon");
    const clearChatBtn = document.getElementById("clearChat");

    const chipClinica = document.getElementById("chipClinica");
    const chipExames = document.getElementById("chipExames");
    const chipAula = document.getElementById("chipAula");
    const chipSutura = document.getElementById("chipSutura");
    const chipAlexia = document.getElementById("chipAlexia");

    const STORAGE_KEY = "carameloChatHistory";
    const THEME_KEY = "carameloTheme";

    let isListening = false;
    let recognition = null;

    function scrollBottom() {
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function saveHistory() {
      const allMsgs = [];
      const bubbles = messagesEl.querySelectorAll(".msg-row");

      bubbles.forEach(row => {
        if (row.id === "typingRow") return;
        const isUser = row.classList.contains("user");
        const textEl = row.querySelector(".msg-text") || row.querySelector(".msg");
        if (!textEl) return;
        allMsgs.push({
          role: isUser ? "user" : "assistant",
          content: textEl.textContent
        });
      });

      localStorage.setItem(STORAGE_KEY, JSON.stringify(allMsgs));
    }

    function loadHistory() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        addCarameloMessage("Oi, eu sou o Caramelo Vet! üê∂\n\nMe conta qual caso cl√≠nico est√° te desafiando hoje ou use um dos quebra-gelos acima.");
        return;
      }

      try {
        const arr = JSON.parse(raw);
        arr.forEach(msg => {
          if (msg.role === "user") {
            addUserMessage(msg.content, false);
          } else {
            addCarameloMessage(msg.content, false);
          }
        });
      } catch (e) {
        console.error("Erro ao carregar hist√≥rico:", e);
        addCarameloMessage("Oi, eu sou o Caramelo Vet! üê∂\n\nMe conta qual caso cl√≠nico est√° te desafiando hoje ou use um dos quebra-gelos acima.");
      }
    }

    function addUserMessage(text, save = true) {
      const row = document.createElement("div");
      row.classList.add("msg-row", "user");

      const bubble = document.createElement("div");
      bubble.classList.add("msg", "user");
      bubble.textContent = text;

      row.appendChild(bubble);
      messagesEl.insertBefore(row, typingRow);
      scrollBottom();

      if (save) saveHistory();
    }

    function addCarameloMessage(text, save = true) {
      const row = document.createElement("div");
      row.classList.add("msg-row", "caramelo");

      const bubble = document.createElement("div");
      bubble.classList.add("msg", "caramelo");

      const avatar = document.createElement("div");
      avatar.classList.add("msg-avatar");
      avatar.textContent = "üê∂";

      const msgText = document.createElement("div");
      msgText.classList.add("msg-text");
      msgText.textContent = text;

      bubble.appendChild(avatar);
      bubble.appendChild(msgText);
      row.appendChild(bubble);

      messagesEl.insertBefore(row, typingRow);
      scrollBottom();

      if (save) saveHistory();
    }

    function showTyping(show) {
      typingRow.style.display = show ? "flex" : "none";
      if (show) scrollBottom();
    }

    async function enviarParaCaramelo(text) {
      showTyping(true);
      try {
        const response = await fetch("https://caramelo-vet.onrender.com/caramelo/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: EMAIL, message: text })
        });

        const data = await response.json();
        showTyping(false);

        if (data.reply) {
          addCarameloMessage(data.reply);
        } else if (data.error) {
          addCarameloMessage("‚ö†Ô∏è Erro: " + data.error);
        } else {
          addCarameloMessage("‚ö†Ô∏è Resposta inesperada do servidor.");
        }
      } catch (err) {
        console.error(err);
        showTyping(false);
        addCarameloMessage("‚ö†Ô∏è Erro ao conectar com o servidor.");
      }
    }

    function handleSend() {
      const text = input.value.trim();
      if (!text) return;
      addUserMessage(text);
      input.value = "";
      enviarParaCaramelo(text);
    }

    sendBtn.addEventListener("click", handleSend);

    input.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        handleSend();
      }
    });

    clearChatBtn.addEventListener("click", () => {
      if (!confirm("Deseja realmente limpar toda a conversa?")) return;
      const rows = messagesEl.querySelectorAll(".msg-row");
      rows.forEach(row => {
        if (row.id !== "typingRow") row.remove();
      });
      localStorage.removeItem(STORAGE_KEY);
      addCarameloMessage("Conversa limpa! Me conte o pr√≥ximo caso cl√≠nico ou escolha um quebra-gelo üê∂");
    });

    function applyTheme(theme) {
      if (theme === "dark") {
        document.body.classList.add("dark");
        themeIcon.textContent = "‚òÄÔ∏è";
      } else {
        document.body.classList.remove("dark");
        themeIcon.textContent = "üåô";
      }
      localStorage.setItem(THEME_KEY, theme);
    }

    themeToggle.addEventListener("click", () => {
      const current = document.body.classList.contains("dark") ? "dark" : "light";
      const next = current === "dark" ? "light" : "dark";
      applyTheme(next);
    });

    function initTheme() {
      const saved = localStorage.getItem(THEME_KEY);
      if (!saved) {
        applyTheme("light");
      } else {
        applyTheme(saved);
      }
    }

    function initMic() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        micBtn.title = "Ditado por voz n√£o suportado";
        micBtn.disabled = true;
        micBtn.style.opacity = 0.5;
        return;
      }

      recognition = new SpeechRecognition();
      recognition.lang = "pt-BR";
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onstart = () => {
        isListening = true;
        micBtn.textContent = "‚èπÔ∏è";
      };

      recognition.onend = () => {
        isListening = false;
        micBtn.textContent = "üéôÔ∏è";
      };

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        if (transcript) {
          input.value = transcript;
          input.focus();
        }
      };

      recognition.onerror = () => {
        isListening = false;
        micBtn.textContent = "üéôÔ∏è";
      };

      micBtn.addEventListener("click", () => {
        if (!recognition) return;
        if (isListening) {
          recognition.stop();
        } else {
          recognition.start();
        }
      });
    }

    function setPrefill(text) {
      input.value = text;
      input.focus();
      input.selectionStart = input.selectionEnd = input.value.length;
    }

    chipClinica.addEventListener("click", () => {
      setPrefill("Cl√≠nica m√©dica de c√£es e gatos üê∂üê±\n\nMe conte o caso: esp√©cie, ra√ßa, idade, sexo, sinais cl√≠nicos e evolu√ß√£o.");
    });

    chipExames.addEventListener("click", () => {
      setPrefill("Interpreta√ß√£o de exames ü©∫üìä\n\nEnvie hemograma, bioqu√≠mica ou imagem com valores e refer√™ncias. Conte tamb√©m o quadro cl√≠nico.");
    });

    chipAula.addEventListener("click", () => {
      setPrefill("Gravar/estruturar aula üé•üìö\n\nTema: ________\nPontos principais:");
    });

    chipSutura.addEventListener("click", () => {
      setPrefill("Fio e padr√£o de sutura ü™°\n\nInforme cirurgia, regi√£o anat√¥mica, porte e comorbidades relevantes.");
    });

    chipAlexia.addEventListener("click", () => {
      setPrefill("Alexia, d√∫vida r√°pida ‚ö°\n\nPergunta objetiva:");
    });

    initTheme();
    loadHistory();
    initMic();
  </script>
</body>
</html>
